<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>API 查询工具</title>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { background:#111; color:#fff; padding:20px; font-family:Arial }
    textarea,input { width:100%; margin-bottom:10px; padding:8px; background:#222; color:#fff; border:1px solid #444 }
    button { padding:8px 16px; background:#2563eb; color:#fff; border:none; cursor:pointer }
    button:hover { background:#1d4ed8 }
    table { width:100%; margin-top:20px; border-collapse:collapse }
    td,th { border:1px solid #444; padding:6px; text-align:center }
    .log { margin-top:10px; color:#94a3b8 }
  </style>
</head>

<body>

<h2>Exhub 批量查询</h2>

<label>Bearer Token</label>
<input id="token" value="">

<label>CF_Authorization</label>
<input id="cookie" value="">

<label>UserID（每行一个）</label>
<textarea id="userids" style="height: 200px;"></textarea>

<button onclick="run()">开始查询</button>

<div class="log" id="exhubLog"></div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>UserID</th>
      <th>FeeUSDT</th>
      <th>TradeDate</th>
    </tr>
  </thead>
  <tbody id="result"></tbody>
</table>

<script>

function exportXlsx(rows) {
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "feeusdt");
  XLSX.writeFile(wb, `feeusdt_${Date.now()}.xlsx`);
}

async function run() {

  const token = document.getElementById('token').value.trim();
  const cookie = document.getElementById('cookie').value.trim();
  const log = document.getElementById("exhubLog");
  const tbody = document.getElementById('result');

  const userids = document.getElementById('userids').value
    .split('\n')
    .map(v=>v.trim())
    .filter(Boolean);

  if (!userids.length) {
    alert("请输入 UserID");
    return;
  }

  tbody.innerHTML = "";
  const rows = [];

  for (let i = 0; i < userids.length; i++) {

    log.innerText = `⏳ 查询 ${i + 1} / ${userids.length}`;

    const body = {
      needpage: 1,
      pagecount: 20,
      userid: userids[i],
      time_type: "1"
    };

    try {

      const res = await axios.post(
        'http://localhost:3000/exhub',
        { token, cookie, body }
      );

      const row = res.data?.data?.dataset?.[0] || {};

      const dataRow = {
        index: i+1,
        userid: userids[i],
        feeusdt: Number(row.feeusdt || 0),
        traddate: row.traddate || ""
      };

      rows.push(dataRow);

      tbody.innerHTML += `
        <tr>
          <td>${dataRow.index}</td>
          <td>${dataRow.userid}</td>
          <td>${dataRow.feeusdt}</td>
          <td>${dataRow.traddate || "-"}</td>
        </tr>
      `;

    } catch(e) {

      rows.push({
        index: i+1,
        userid: userids[i],
        feeusdt: "ERROR",
        traddate: ""
      });

      tbody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${userids[i]}</td>
          <td style="color:red">ERROR</td>
          <td>-</td>
        </tr>
      `;
    }
  }

  log.innerText = `✅ 查询完成，共 ${rows.length} 条`;

  exportXlsx(rows);
}

</script>

</body>
</html>
